<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout :: head-fragment (pageTitle='Loading...')}"></head>

<body>
<div class="mil-wrapper" id="top">
    <div th:replace="~{layout :: cursor-fragment}"></div>
    <div th:replace="~{layout :: preloader-fragment}"></div>
    <div th:replace="~{layout :: progress-track-fragment}"></div>
    <div th:replace="~{layout :: menu-fragment}"></div>
    <div th:replace="~{layout :: curtain-fragment}"></div>
    <div th:replace="~{layout :: frame-fragment}"></div>

    <div class="mil-content">
        <div id="swupMain" class="mil-main-transition">

            <div class="mil-inner-banner">
                <div class="mil-banner-content mil-up">
                    <div class="mil-animation-frame">
                        <div class="mil-animation mil-position-4 mil-dark mil-scale" data-value-1="6" data-value-2="1.4"></div>
                    </div>
                    <div class="container">
                        <ul class="mil-breadcrumbs mil-mb-60">
                            <li><a th:href="@{/}">Homepage</a></li>
                            <li><a th:href="@{/portfolio}">Portfolio</a></li>
                            <li><a href="#" id="dynamic-breadcrumb">Loading...</a></li>
                        </ul>
                        <h1 class="mil-mb-60" id="dynamic-title">Loading...</h1>
                        <a href="#project" class="mil-link mil-dark mil-arrow-place mil-down-arrow">
                            <span>Read more</span>
                        </a>
                    </div>
                </div>
            </div>

            <section class="mil-p-120-0">
                <div class="container mil-p-0-120" id="project">

                    <div class="mil-image-frame mil-horizontal mil-up">
                        <img src="" id="dynamic-cover-img" alt="cover">
                    </div>

                    <div class="mil-info mil-up">
                        <div>Client: &nbsp;<span class="mil-dark">DIDO Client</span></div>
                        <div>Date: &nbsp;<span class="mil-dark" id="dynamic-date">...</span></div>
                        <div>Author: &nbsp;<span class="mil-dark">DIDO Creative</span></div>
                    </div>

                    <div class="mil-p-120-0" id="dynamic-sections-container">
                    </div>

                    <div class="mil-works-nav mil-up">
                        <a th:href="@{/portfolio}" class="mil-link mil-dark">
                            <span>All projects</span>
                        </a>
                    </div>
                </div>
            </section>

        </div>
    </div>
    <div th:replace="~{layout :: footer-fragment}"></div>
</div>
<div th:replace="~{layout :: scripts-fragment}"></div>

<script>
    document.addEventListener("DOMContentLoaded", function() {

        // 1. Get ID from URL (e.g., /portfolio/5 -> gets "5")
        const pathArray = window.location.pathname.split('/');
        const id = pathArray[pathArray.length - 1];

        // 2. Fetch Data
        fetch('/api/portfolio/' + id)
            .then(response => {
                if (!response.ok) throw new Error("Not Found");
                return response.json();
            })
            .then(data => {
                const p = data.portfolio;

                // 3. Update Basic Info
                document.title = p.title + ' - DIDO Creative Studio';
                document.getElementById('dynamic-title').innerText = p.title;
                document.getElementById('dynamic-breadcrumb').innerText = p.title;
                document.getElementById('dynamic-cover-img').src = p.coverImageUrl;
                document.getElementById('dynamic-date').innerText = new Date(p.createdTime).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

                // 4. Build Sections HTML
                let sectionsHtml = '';

                // A. Copywriting Sections
                data.copywritingSections.forEach(textDTO => {
                    let paragraphs = '';
                    textDTO.copywritingList.forEach(item => {
                        paragraphs += `<p class="mil-up">${item.copytext}</p>`;
                    });

                    sectionsHtml += `
                        <div class="row justify-content-between mil-p-90-120">
                            <div class="col-lg-5">
                                <h3 class="mil-up mil-mb-60">${textDTO.section.value}</h3>
                            </div>
                            <div class="col-lg-6">
                                <p class="mil-up mil-mb-30"><strong>${textDTO.section.description}</strong></p>
                                ${paragraphs}
                            </div>
                        </div>
                    `;
                });

                // B. Image Sections
                data.imageSections.forEach(imgDTO => {
                    let imagesHtml = '';
                    imgDTO.images.forEach(img => {
                        imagesHtml += `
                            <div class="col-lg-6">
                                <div class="mil-image-frame mil-vertical mil-up mil-mb-30">
                                    <img src="${img.imageUrl}" alt="project image">
                                    <a data-fancybox="gallery" data-no-swup href="${img.imageUrl}" class="mil-zoom-btn">
                                        <img src="/img/icons/zoom.svg" alt="zoom">
                                    </a>
                                </div>
                            </div>
                        `;
                    });

                    sectionsHtml += `
                        <div class="row mil-p-0-90">
                            <div class="col-lg-12">
                                <h4 class="mil-up mil-mb-30">${imgDTO.section.value}</h4>
                                <p class="mil-up mil-mb-30">${imgDTO.section.description}</p>
                            </div>
                        </div>
                        <div class="row mil-p-0-90">
                            ${imagesHtml}
                        </div>
                    `;
                });

                // 5. Inject Sections
                document.getElementById('dynamic-sections-container').innerHTML = sectionsHtml;

            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('dynamic-title').innerText = "Project Not Found";
            });
    });
</script>

</body>
</html>